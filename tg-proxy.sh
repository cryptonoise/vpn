#!/bin/sh

set -e

# ะฆะฒะตัะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# -------------------------------
# ะัะธะฒะตัััะฒะธะต
# -------------------------------
show_welcome() {
    clear
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "${BLUE}โ  ๐ก MTProto Proxy ะดะปั Telegram         โ${NC}\n"
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "\n"
    printf "${GREEN}ะงัะพ ะดะตะปะฐะตั ัะบัะธะฟั:${NC}\n"
    printf "  โข ะัะพะฒะตััะตั Docker\n"
    printf "  โข ะะฐัััะฐะธะฒะฐะตั ัะฐะตัะฒะพะป (ะพะฟัะธะพะฝะฐะปัะฝะพ)\n"
    printf "  โข ะะฐะทะฒะพัะฐัะธะฒะฐะตั MTProto-ะฟัะพะบัะธ ั ะผะฐัะบะธัะพะฒะบะพะน ะฟะพะด HTTPS\n"
    printf "  โข ะะตะฝะตัะธััะตั ัััะปะบั ะดะปั ะฟะพะดะบะปััะตะฝะธั ะฒ Telegram\n"
    printf "\n"
    printf "${YELLOW}๐ ะะฐัะธะฝะฐะตะผ...${NC}\n\n"
}

# -------------------------------
# ะัะพะฒะตัะบะฐ root
# -------------------------------
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        printf "โ ะกะบัะธะฟั ััะตะฑัะตั ะฟัะฐะฒ root. ะะฐะฟัััะธัะต ั sudo.\n" >&2
        exit 1
    fi
}

# -------------------------------
# IP ัะตัะฒะตัะฐ
# -------------------------------
get_server_ip() {
    curl -s4 https://ifconfig.me 2>/dev/null || curl -s4 https://api.ipify.org 2>/dev/null || echo "0.0.0.0"
}

# -------------------------------
# ะะฐะฒะธัะธะผะพััะธ
# -------------------------------
install_deps() {
    :
}

# -------------------------------
# ะัะฟัะฐะฒะปะตะฝะธะต dpkg
# -------------------------------
fix_dpkg() {
    printf "${RED}โ๏ธ  ะะฑะฝะฐััะถะตะฝะฐ ะพัะธะฑะบะฐ. ะัะฟัะฐะฒะปัั...${NC}\n"
    pkill -9 -f "dpkg" 2>/dev/null || true
    pkill -9 -f "apt" 2>/dev/null || true
    rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock /var/lib/apt/lists/lock
    dpkg --configure -a 2>/dev/null || true
    apt-get install -f -y 2>/dev/null || true
    apt-get update -qq 2>/dev/null || true
    printf "${GREEN}โ ะกะธััะตะผะฐ ะธัะฟัะฐะฒะปะตะฝะฐ. ะะพะฒัะพััั...${NC}\n\n"
}

# -------------------------------
# ะฃััะฐะฝะพะฒะบะฐ Docker
# -------------------------------
install_docker() {
    if command -v docker >/dev/null 2>&1; then
        printf "โ Docker ัะถะต ัััะฐะฝะพะฒะปะตะฝ\n\n"
        return 0
    fi
    
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "๐ณ ะฃััะฐะฝะฐะฒะปะธะฒะฐั Docker...\n"
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    
    if curl -fsSL https://get.docker.com | sh 2>/dev/null; then
        printf "\n${GREEN}โ Docker ัััะฐะฝะพะฒะปะตะฝ${NC}\n\n"
        return 0
    fi
    
    fix_dpkg
    
    if curl -fsSL https://get.docker.com | sh; then
        printf "\n${GREEN}โ Docker ัััะฐะฝะพะฒะปะตะฝ${NC}\n\n"
        return 0
    fi
    
    printf "${RED}โ ะะต ัะดะฐะปะพัั ัััะฐะฝะพะฒะธัั Docker${NC}\n" >&2
    exit 1
}

# -------------------------------
# ะะฝัะตัะฐะบัะธะฒะฝัะต ะฟะฐัะฐะผะตััั
# -------------------------------
ask_params() {
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "โ๏ธ  ะะฐัััะพะนะบะฐ ะฟัะพะบัะธ\n"
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n\n"

    # ะะพัั
    printf "๐น ะะฒะตะดะธัะต ะฟะพัั ะฟัะพะบัะธ [ะฟะพ ัะผะพะปัะฐะฝะธั - 8443]: "
    read -r PROXY_PORT_INPUT < /dev/tty || true
    PROXY_PORT=${PROXY_PORT_INPUT:-8443}
    case "$PROXY_PORT" in
        ''|*[!0-9]*) printf "โ๏ธ  ะะตะบะพััะตะบัะฝัะน ะฟะพัั, ะธัะฟะพะปัะทัะตะผ 8443\n"; PROXY_PORT=8443 ;;
        *) if [ "$PROXY_PORT" -lt 1 ] || [ "$PROXY_PORT" -gt 65535 ]; then
               printf "โ๏ธ  ะะตะบะพััะตะบัะฝัะน ะฟะพัั, ะธัะฟะพะปัะทัะตะผ 8443\n"; PROXY_PORT=8443
           fi ;;
    esac
    printf "โ ะะพัั: %s\n\n" "$PROXY_PORT"

    # Fake TLS
    while true; do
        printf "๐น ะะฒะตะดะธัะต Fake TLS ะดะพะผะตะฝ: "
        read -r FAKE_TLS_DOMAIN_INPUT < /dev/tty || true
        FAKE_TLS_DOMAIN_INPUT=$(printf "%s" "$FAKE_TLS_DOMAIN_INPUT" | tr -d '[:space:]') 
        
        if [ -n "$FAKE_TLS_DOMAIN_INPUT" ]; then
            FAKE_TLS_DOMAIN="$FAKE_TLS_DOMAIN_INPUT"
            break
        else
            printf "${RED}โ๏ธ  ะะพะผะตะฝ ะฝะต ะผะพะถะตั ะฑััั ะฟััััะผ. ะะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ.${NC}\n"
        fi
    done
    printf "โ Fake TLS ะดะพะผะตะฝ: %s\n\n" "$FAKE_TLS_DOMAIN"

    # ะะพะผะตะฝ ะดะปั ัััะปะบะธ
    printf "๐น ะะฒะตะดะธัะต ะฒะฐั ะดะพะผะตะฝ ะดะปั ัััะปะบะธ\n   (ะธะปะธ Enter ััะพะฑั ะธัะฟะพะปัะทะพะฒะฐัั IP ััะพะณะพ ัะตัะฒะตัะฐ): "
    read -r PROXY_DOMAIN_INPUT < /dev/tty || true
    if [ -z "$PROXY_DOMAIN_INPUT" ]; then
        PROXY_DOMAIN=$(get_server_ip)
        printf "โน๏ธ  ะัะดะตั ะธัะฟะพะปัะทะพะฒะฐะฝ IP: %s\n\n" "$PROXY_DOMAIN"
    else
        PROXY_DOMAIN="$PROXY_DOMAIN_INPUT"
        printf "โ ะะพะผะตะฝ: %s\n\n" "$PROXY_DOMAIN"
    fi
}

# -------------------------------
# ะคะฐะตัะฒะพะป
# -------------------------------
setup_firewall() {
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "๐ฅ ะะฐัััะพะธัั ัะฐะตัะฒะพะป (UFW)? [Enter - ะฝะตั | Y - ะดะฐ]: "
    read -r UFW_CHOICE < /dev/tty || true
    UFW_CHOICE=$(printf "%s" "$UFW_CHOICE" | tr '[:lower:]' '[:upper:]')
    
    if [ "$UFW_CHOICE" = "Y" ] || [ "$UFW_CHOICE" = "YES" ]; then
        printf "๐ง ะัะธะผะตะฝัั ะฟัะฐะฒะธะปะฐ UFW...\n"
        ufw default deny incoming 2>/dev/null || true
        ufw default allow outgoing 2>/dev/null || true
        ufw allow 22/tcp 2>/dev/null || true
        ufw allow "${PROXY_PORT}"/tcp 2>/dev/null || true
        [ "${PROXY_PORT}" != "443" ] && ufw allow 443/tcp 2>/dev/null || true
        printf "y\n" | ufw enable 2>/dev/null || true
        
        # ะคะพัะผะธััะตะผ ัะฟะธัะพะบ ะพัะบััััั ะฟะพััะพะฒ
        OPEN_PORTS="22/tcp, ${PROXY_PORT}/tcp"
        [ "${PROXY_PORT}" != "443" ] && OPEN_PORTS="${OPEN_PORTS}, 443/tcp"
        
        printf "โ ะคะฐะตัะฒะพะป ะฝะฐัััะพะตะฝ\n"
        printf "๐ ะัะบัััั ะฟะพััั: %s\n\n" "$OPEN_PORTS"
    else
        printf "โญ๏ธ  ะัะพะฟััะตะฝะพ (ัะฐะตัะฒะพะป ะฝะต ะฝะฐัััะพะตะฝ)\n\n"
    fi
}

# -------------------------------
# ะะตะฝะตัะฐัะธั ัะตะบัะตัะฐ
# -------------------------------
generate_secret() {
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "๐ ะะตะฝะตัะฐัะธั ัะตะบัะตัะฝะพะณะพ ะบะปััะฐ...\n"
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    SECRET=$(docker run --rm nineseconds/mtg:2 generate-secret --hex "${FAKE_TLS_DOMAIN}")
    printf "\nโ ะกะตะบัะตั ัะณะตะฝะตัะธัะพะฒะฐะฝ\n\n"
}

# -------------------------------
# ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะฐ (ั ะปะพะณะธะบะพะน ะฟะตัะตัััะฐะฝะพะฒะบะธ)
# -------------------------------
run_proxy() {
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "๐ ะะฐะฟััะบ MTProxy ะบะพะฝัะตะนะฝะตัะฐ...\n"
    printf "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    
    # ะัะพะฒะตััะตะผ, ัััะตััะฒัะตั ะปะธ ะบะพะฝัะตะนะฝะตั ั ะธะผะตะฝะตะผ "telegram"
    if docker ps -a --filter name=^/telegram$ --format "{{.ID}}" | grep -q .; then
        printf "${YELLOW}โ๏ธ  ะะพะฝัะตะนะฝะตั 'telegram' ัะถะต ัััะตััะฒัะตั.${NC}\n"
        printf "๐น ะะตัะตัััะฐะฝะพะฒะธัั ะบะพะฝัะตะนะฝะตั? [Enter=ะดะฐ / N=ะฝะตั]: "
        read -r REINSTALL_CHOICE < /dev/tty || true
        REINSTALL_CHOICE=$(printf "%s" "$REINSTALL_CHOICE" | tr '[:upper:]' '[:lower:]')
        
        if [ -z "$REINSTALL_CHOICE" ] || [ "$REINSTALL_CHOICE" = "y" ] || [ "$REINSTALL_CHOICE" = "yes" ]; then
            # โ ะะพะปัะทะพะฒะฐัะตะปั ัะพะณะปะฐัะธะปัั ะฝะฐ ะฟะตัะตัััะฐะฝะพะฒะบั โ ะณะตะฝะตัะธััะตะผ ะะะะซะ ัะตะบัะตั
            generate_secret
            printf "๐๏ธ  ะฃะดะฐะปัั ััะฐััะน ะบะพะฝัะตะนะฝะตั...\n"
            docker stop telegram 2>/dev/null || true
            docker rm telegram 2>/dev/null || true
            printf "โ ะกัะฐััะน ะบะพะฝัะตะนะฝะตั ัะดะฐะปัะฝ\n"
        else
            # โ ะะพะปัะทะพะฒะฐัะตะปั ะพัะบะฐะทะฐะปัั โ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะบัะธะฟั
            printf "\n${YELLOW}โญ๏ธ  ะัะพะบัะธ ะฝะต ะฑัะป ะฟะตัะตัััะฐะฝะพะฒะปะตะฝ. ะกะบัะธะฟั ะทะฐะฒะตัััะฝ.${NC}\n"
            printf "${BLUE}๐ก ะงัะพะฑั ัะพะทะดะฐัั ะฝะพะฒัะน ะฟัะพะบัะธ, ะทะฐะฟัััะธัะต ัะบัะธะฟั ัะฝะพะฒะฐ ะธ ะฝะฐะถะผะธัะต Enter.${NC}\n\n"
            exit 0
        fi
    else
        # โ ะะพะฝัะตะนะฝะตัะฐ ะฝะตั โ ะณะตะฝะตัะธััะตะผ ัะตะบัะตั ะดะปั ะฝะพะฒะพะณะพ
        generate_secret
    fi
    
    # ะะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตั (SECRET ัะถะต ะพะฟัะตะดะตะปัะฝ)
    docker run -d \
        --name telegram \
        --restart unless-stopped \
        -p "${PROXY_PORT}":8443 \
        nineseconds/mtg:2 \
        simple-run -n 1.1.1.1 -i prefer-ipv4 0.0.0.0:8443 "${SECRET}"
    
    printf "\nโ ะะพะฝัะตะนะฝะตั ะทะฐะฟััะตะฝ\n\n"
}

# -------------------------------
# ะะตะทัะปััะฐั
# -------------------------------
show_result() {
    printf "\n"
    printf "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "${GREEN}โ  ๐ ะัะพะบัะธ ะณะพัะพะฒ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!      โ${NC}\n"
    printf "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
    printf "\n"
    printf "${YELLOW}๐ ะกััะปะบะฐ ะดะปั Telegram:${NC}\n"
    printf "https://t.me/proxy?server=%s&port=%s&secret=%s\n" "$PROXY_DOMAIN" "$PROXY_PORT" "$SECRET"
    printf "\n"
    printf "${YELLOW}๐ก ะะฐะบ ะฟะพะดะบะปััะธัั:${NC}\n"
    printf "  1. ะกะบะพะฟะธััะนัะต ัััะปะบั ะฒััะต\n"
    printf "  2. ะัะบัะพะนัะต ะตั ะฒ Telegram\n"
    printf "  3. ะะฐะถะผะธัะต ยซะะพะฑะฐะฒะธัั ะฟัะพะบัะธยป\n"
    printf "  4. ะัะพะฒะตัััะต: ะะฐัััะพะนะบะธ โ ะะฐะฝะฝัะต ะธ ะฟะฐะผััั โ ะัะพะบัะธ โ โ\n"
    printf "\n"
    printf "${BLUE}๐ง ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:${NC}\n"
    printf "  docker restart telegram          # ะฟะตัะตะทะฐะฟัััะธัั\n"
    printf "  docker stop telegram && docker rm telegram  # ัะดะฐะปะธัั\n"
    printf "\n"
}

# -------------------------------
# MAIN
# -------------------------------
main() {
    show_welcome
    check_root
    install_deps
    install_docker
    ask_params
    setup_firewall
    run_proxy
    show_result
}

# -------------------------------
# ะะฐะฟััะบ
# -------------------------------
main
